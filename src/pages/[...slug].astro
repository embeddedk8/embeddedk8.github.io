---
import { type CollectionEntry, getCollection } from 'astro:content';
import Prose from '../components/Prose.astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import { Image } from 'astro:assets';
import FormattedDate from '../components/FormattedDate.astro';
import { slugify } from '../utils';
import { loadEnv } from 'vite';
import { render } from 'astro:content';

const { GISCUS_REPO, GISCUS_REPO_ID, GISCUS_CATEGORY, GISCUS_CATEGORY_ID } = loadEnv(process.env.NODE_ENV || 'production', process.cwd(), '');

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post: any) => ({
		params: { slug: post.id },
		props: post
	}));
}

type Props = CollectionEntry<'blog'>;
const post = Astro.props;
const {
	data: { title, seoTitle, description, coverImage, pubDate, updatedDate, tags }
} = post;
const { Content, headings } = await render(post);
---

<BaseLayout title={seoTitle || title} description={description} image={coverImage?.src || undefined}>
    <div class='mx-auto max-w-full px-4 sm:max-w-[90ch]'>
		<main class='overflow-hidden grow'>
			<article>
				<Prose>
					<div>
						<h1 class='mt-10 !mb-1 leading-tight'>{title}</h1>
                        <div class="flex flex-wrap items-center gap-2 text-sm text-zinc-600 dark:text-zinc-400 mt-2">
                          {
                            (tags || []).map((tag: string) => (
                              <a
                                href={`/tags/${slugify(tag)}`}
                                class="px-2 py-0.5 rounded-full border border-zinc-300 dark:border-zinc-700 hover:border-zinc-700 dark:hover:border-zinc-300 transition-colors no-underline"
                              >
                                {tag}
                              </a>
                            ))
                          }

                          <span class="mx-1">â€¢</span>

                          <span>
                            {
                              updatedDate
                                ? <><strong><FormattedDate date={updatedDate} /></strong></>
                                : <><strong><FormattedDate date={pubDate} /></strong></>
                            }
                          </span>
                        </div>
					</div>

					<div class='py-3 overflow-hidden'>
						{coverImage && <Image class='rounded-3xl w-full m-0 lg:mb-2' src={coverImage} alt={title} loading='eager' />}
					</div>

					<Content />
				</Prose>

				{
					GISCUS_REPO &&
					<script
						id='giscus-script'
						is:inline
						src='https://giscus.app/client.js'
						data-repo={GISCUS_REPO}
						data-repo-id={GISCUS_REPO_ID}
						data-category={GISCUS_CATEGORY}
						data-category-id={GISCUS_CATEGORY_ID}
						data-mapping='pathname'
						data-strict='0'
						data-reactions-enabled='1'
						data-emit-metadata='0'
						data-input-position='bottom'
						data-theme='preferred_color_scheme'
						data-lang='en'
						crossorigin='anonymous'
						async></script>
				}
			</article>
		</main>
	</div>
</BaseLayout>

<script async is:inline>
	const anchors = document.querySelectorAll('.prose h2[id], .prose h3[id]');
	const links = document.querySelectorAll('nav.toc ul li a');
</script>
